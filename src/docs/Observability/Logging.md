# Logging (Loki)

–Ø–∫—â–æ **Prometheus** ‚Äî —Ü–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫ (—Ä–∞—Ö—É—î —Ü–∏—Ñ—Ä–∏), –∞ **Sentry** ‚Äî —Ü–µ –ª—ñ–∫–∞—Ä (–ª—ñ–∫—É—î —Ç—Ä–∞–≤–º–∏/–ø–æ–º–∏–ª–∫–∏), —Ç–æ **Loki** ‚Äî —Ü–µ **–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ä-–∞—Ä—Ö—ñ–≤–∞—Ä—ñ—É—Å**.

–í—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞—î —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–¥—ñ–π.

### –©–æ —Ç–∞–∫–µ Grafana Loki? ü™µ

–ü—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏: —Ü–µ **"Prometheus –¥–ª—è –ª–æ–≥—ñ–≤"**.
–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä–∏ –ª—é–±–ª—è—Ç—å –π–æ–≥–æ –∑–∞ –æ–¥–Ω—É —Ä—ñ—á: –≤—ñ–Ω **–¥–µ—à–µ–≤–∏–π —ñ —à–≤–∏–¥–∫–∏–π**.

–¢—Ä–∞–¥–∏—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ (—è–∫ ELK Stack / Elasticsearch) —ñ–Ω–¥–µ–∫—Å—É—é—Ç—å _–∫–æ–∂–Ω–µ —Å–ª–æ–≤–æ_ –≤ –ª–æ–∑—ñ. –¶–µ –¥–æ—Ä–æ–≥–æ (–±–∞–≥–∞—Ç–æ –ø–∞–º'—è—Ç—ñ —Ç–∞ –¥–∏—Å–∫—ñ–≤).
Loki –Ω–µ —ñ–Ω–¥–µ–∫—Å—É—î —Ç–µ–∫—Å—Ç –ª–æ–≥—É. –í—ñ–Ω —ñ–Ω–¥–µ–∫—Å—É—î —Ç—ñ–ª—å–∫–∏ **—Ç–µ–≥–∏ (labels)** (—è–∫ Prometheus: `app="frontend"`, `env="prod"`). –ê —Å–∞–º —Ç–µ–∫—Å—Ç —à—É–∫–∞—î –ø—Ä—è–º–∏–º –ø–µ—Ä–µ–±–æ—Ä–æ–º (—è–∫ `grep`), –∞–ª–µ –¥—É–∂–µ —à–≤–∏–¥–∫–æ –∑–∞–≤–¥—è–∫–∏ –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º—É.

---

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ –º—ñ—Å—Ü–µ: Loki vs Sentry

–ë–∞–≥–∞—Ç–æ —Ö—Ç–æ –ø–ª—É—Ç–∞—î: "–ù–∞–≤—ñ—â–æ –º–µ–Ω—ñ Loki, —è–∫—â–æ —î Sentry?".
–û—Å—å —á—ñ—Ç–∫–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª ("Separation of Concerns"):

| –¢–∏–ø –ø–æ–¥—ñ—ó             | –ö—É–¥–∏ —Å–ª–∞—Ç–∏?    | –ü—Ä–∏–∫–ª–∞–¥                                                                       |
| --------------------- | -------------- | ----------------------------------------------------------------------------- |
| **Exception / Crash** | **Sentry** üî¥  | `Uncaught TypeError: Cannot read property of undefined`                       |
| **Warning / Info**    | **Loki** üü°/üîµ | "User clicked 'Export PDF'", "Payment modal opened", "Search query: 'iPhone'" |
| **Debug**             | **Loki** ‚ö™    | "API response time: 200ms", "Websocket connected"                             |

**Sentry** ‚Äî –¥–ª—è —Ç–æ–≥–æ, —â–æ **–∑–ª–∞–º–∞–ª–æ—Å—è**.
**Loki** ‚Äî –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏ **–∫–æ–Ω—Ç–µ–∫—Å—Ç** (—â–æ —Ä–æ–±–∏–≤ —é–∑–µ—Ä _–ø–µ—Ä–µ–¥ —Ç–∏–º_, —è–∫ –≤—Å–µ –∑–ª–∞–º–∞–ª–æ—Å—è, –∞–±–æ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –∞—É–¥–∏—Ç—É).

---

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î –Ω–∞ –§—Ä–æ–Ω—Ç–µ–Ω–¥—ñ? üèóÔ∏è

–Ø–∫ —ñ –∑ Prometheus, –º–∏ **–Ω–µ** –ø–∏—à–µ–º–æ –≤ Loki –Ω–∞–ø—Ä—è–º—É –∑ –±—Ä–∞—É–∑–µ—Ä–∞ (—á–µ—Ä–µ–∑ CORS —Ç–∞ –±–µ–∑–ø–µ–∫—É). –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–æ–∫—Å—ñ.

#### 1. –°—Ö–µ–º–∞ –ø–æ—Ç–æ–∫—É –¥–∞–Ω–∏—Ö

`Browser` -> `Next.js API (Proxy)` -> `Loki` -> `Grafana`

#### 2. –§–æ—Ä–º–∞—Ç –ª–æ–≥—É

Loki –ø—Ä–∏–π–º–∞—î –ø—Ä–æ—Å—Ç—ñ JSON –æ–±'—î–∫—Ç–∏ –∑ –º—ñ—Ç–∫–∞–º–∏ (streams) —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏.

#### 3. –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É (Logger Service)

–ù–∞ —Ñ—Ä–æ–Ω—Ç—ñ –º–∏ —Å—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç–∏–π `logger`, —è–∫–∏–π –∑–∞–º—ñ—Å—Ç—å `console.log` —à–ª–µ –¥–∞–Ω—ñ –Ω–∞ –±–µ–∫.

```typescript
// utils/logger.ts

const LOG_LEVELS = {
  info: 'info',
  warn: 'warn',
  error: 'error', // –î–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –Ω–µ —Ç—Ä–µ–±–∞ –≤ Sentry
  debug: 'debug',
};

const sendLog = (level: string, message: string, meta: object = {}) => {
  // –ù–∞ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç—ñ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ–º–æ –≤ –∫–æ–Ω—Å–æ–ª—å
  if (process.env.NODE_ENV === 'development') {
    console.log(`[${level.toUpperCase()}]`, message, meta);
    return;
  }

  // –ù–∞ –ø—Ä–æ–¥—ñ —à–ª–µ–º–æ –≤ Loki (—á–µ—Ä–µ–∑ –Ω–∞—à –ø—Ä–æ–∫—Å—ñ)
  const payload = {
    level,
    message,
    meta,
    timestamp: new Date().toISOString(),
    url: window.location.href, // –í–∞–∂–ª–∏–≤–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
  };

  // navigator.sendBeacon —ñ–¥–µ–∞–ª—å–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –ª–æ–≥—ñ–≤ (–≤–æ–≥–Ω–µ —ñ –∑–∞–±—É–¥—å)
  const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
  navigator.sendBeacon('/api/logs', blob);
};

export const logger = {
  info: (msg: string, meta?: object) => sendLog(LOG_LEVELS.info, msg, meta),
  warn: (msg: string, meta?: object) => sendLog(LOG_LEVELS.warn, msg, meta),
  // ...
};
```

#### 4. –ë–µ–∫–µ–Ω–¥ (Next.js API Route)

–¢—É—Ç –º–∏ —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ–¥ —Ñ–æ—Ä–º–∞—Ç Loki —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ.

```typescript
// pages/api/logs.ts
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { level, message, meta, timestamp } = req.body;

  // –§–æ—Ä–º—É—î–º–æ body –¥–ª—è Loki API
  const lokiPayload = {
    streams: [
      {
        stream: {
          app: 'frontend-app', // Label: –ø–æ –Ω—å–æ–º—É –±—É–¥–µ–º–æ —à—É–∫–∞—Ç–∏
          level: level, // Label: info, warn...
          env: process.env.NODE_ENV,
        },
        values: [
          // Loki –æ—á—ñ–∫—É—î: [ns_epoch_string, log_line_string]
          [
            String(Date.now() * 1000000), // Nanoseconds
            JSON.stringify({ message, meta, user_agent: req.headers['user-agent'] }),
          ],
        ],
      },
    ],
  };

  // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Loki (–∑–∞–∑–≤–∏—á–∞–π —Ü–µ URL —Ç–∏–ø—É http://loki:3100/loki/api/v1/push)
  await fetch(process.env.LOKI_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(lokiPayload),
  });

  res.status(200).json({ status: 'ok' });
}
```

---

### –ú–∞–≥—ñ—è –≤ Grafana ü™Ñ

–ù–∞–π–∫—Ä—É—Ç—ñ—à–µ –≤ Loki ‚Äî —Ü–µ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è.
–û—Å–∫—ñ–ª—å–∫–∏ Loki —ñ Prometheus –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–¥–Ω—ñ –π —Ç—ñ –∂ –ª–µ–π–±–ª–∏ (`app="frontend"`), —Ç–∏ –º–æ–∂–µ—à —Ä–æ–±–∏—Ç–∏ **Split View**:

1. –ó–≤–µ—Ä—Ö—É –≥—Ä–∞—Ñ—ñ–∫ Prometheus: "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫ 500".
2. –¢–∏ –±–∞—á–∏—à "—Å–ø–ª–µ—Å–∫" (Spike) –æ 14:00.
3. –¢–∏ –≤–∏–¥—ñ–ª—è—î—à —Ü–µ–π —à–º–∞—Ç–æ–∫ –º–∏—à–∫–æ—é.
4. –ó–Ω–∏–∑—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç—è–≥—É—é—Ç—å—Å—è –ª–æ–≥–∏ –∑ Loki **—Å–∞–º–µ –∑–∞ —Ü–µ–π –ø—Ä–æ–º—ñ–∂–æ–∫ —á–∞—Å—É** —ñ —Å–∞–º–µ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É.

–¢–æ–±—ñ –Ω–µ —Ç—Ä–µ–±–∞ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ Timestamp —ñ –π—Ç–∏ –≤ —ñ–Ω—à—É –≤–∫–ª–∞–¥–∫—É —à—É–∫–∞—Ç–∏ –ª–æ–≥–∏. –í—Å–µ –Ω–∞ –æ–¥–Ω–æ–º—É –µ–∫—Ä–∞–Ω—ñ.

### LogQL (–ú–æ–≤–∞ –∑–∞–ø–∏—Ç—ñ–≤)

–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä–∏ –ª—é–±–ª—è—Ç—å LogQL. –¶–µ —è–∫ SQL, –∞–ª–µ –¥–ª—è –≥—Ä–µ–ø—É –ª–æ–≥—ñ–≤.
–ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É –≤ Grafana:
`{app="frontend"} |= "error" | json | line_format "{{.message}}"`
_(–ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –ª–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –¥–µ —î —Å–ª–æ–≤–æ "error", —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ JSON —ñ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)_.

---

### –†–µ–∑—é–º–µ –ø–æ Observability Stack

–ú–∏ –∑—ñ–±—Ä–∞–ª–∏ –º–∞–π–∂–µ –ø–æ–≤–Ω–∏–π –ø–∞–∑–ª "Production Grade Monitoring":

1. **Sentry:** "–£ –Ω–∞—Å –ø–æ–∂–µ–∂–∞! (Critical Errors)".
2. **Prometheus:** "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∫—ñ–º–Ω–∞—Ç—ñ –∑—Ä–æ—Å—Ç–∞—î (Metrics/Trends)".
3. **Loki:** "–•—Ä–æ–Ω—ñ–∫–∞ –ø–æ–¥—ñ–π: —Ö—Ç–æ –∑–∞—Ö–æ–¥–∏–≤, —â–æ –Ω–∞—Ç–∏—Å–∫–∞–≤ (Logs/Audit)".

–ó–∞–ª–∏—à–∏–≤—Å—è –æ—Å—Ç–∞–Ω–Ω—ñ–π, –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∏–π, –∞–ª–µ –Ω–∞–π—Ü—ñ–∫–∞–≤—ñ—à–∏–π –µ–ª–µ–º–µ–Ω—Ç ‚Äî **Distributed Tracing (Jaeger / OpenTelemetry)**.

–¶–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è: _"–ß–æ–º—É –∑–∞–ø–∏—Ç `GET /api/dashboard` —Ç—Ä–∏–≤–∞–≤ 5 —Å–µ–∫—É–Ω–¥? –¶–µ —Ñ—Ä–æ–Ω—Ç —Ç—É–ø–∏–≤, –±–∞–∑–∞ –¥–∞–Ω–∏—Ö —á–∏ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π API?"_.

–ì–æ—Ç–æ–≤–∏–π —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ **Tracing**? –¶–µ —Å–∞–º–µ —Ç–µ, —â–æ —Ä–æ–±–∏—Ç—å —Ç–µ–±–µ "–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä–æ–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ".
